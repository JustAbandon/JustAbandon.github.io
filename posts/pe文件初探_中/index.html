<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="Just Abandon">
    <meta name="description" content="稍微详细一点的PE结构    PE文件结构图:
1. DOS MZ Header————IMAGE_DOS_HEADER	DOS MZ 头 2. DOS stub———————MS-DOS Stub Program	DOS 根 3. PE Header——————IMAGE_NT_HEADERS	PE头(NT 头) 4. Section table—————MAGE_SECTION_HEADER 区段头 5.1 Section 1	(.text)	SECTION.text	区段 .text 5-2 Section 2	(.data)	SECTION.data	区段 .data .text：包含程序的可执行代码。 .data:包含初始化数据。 .bss：包含未初始化的数据。 .rdata:包含只读的初始化数据。 .edata：包含导出表。 .idata：包含导入表。 .reloc：包含图像重定位信息。 .rsrc：包含程序使用的资源，包括图像、图标甚至嵌入的二进制文件。 .tls: ( T thread Local S torage )，为程序的每个执行线程提供存储。 PEview视图:
 1.DOS MZ Heade    DOS头结构
DOS_MZ_HEADER:
此结构中 重点参数为e_magic 和 e_lfanew, e_magic 占用两个字节 4D 5A ,转换成字符为MZ,位置在于文件的最开始,可执行文件中不可缺少的一部分.">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PE文件初探_中"/>
<meta name="twitter:description" content="稍微详细一点的PE结构    PE文件结构图:
1. DOS MZ Header————IMAGE_DOS_HEADER	DOS MZ 头 2. DOS stub———————MS-DOS Stub Program	DOS 根 3. PE Header——————IMAGE_NT_HEADERS	PE头(NT 头) 4. Section table—————MAGE_SECTION_HEADER 区段头 5.1 Section 1	(.text)	SECTION.text	区段 .text 5-2 Section 2	(.data)	SECTION.data	区段 .data .text：包含程序的可执行代码。 .data:包含初始化数据。 .bss：包含未初始化的数据。 .rdata:包含只读的初始化数据。 .edata：包含导出表。 .idata：包含导入表。 .reloc：包含图像重定位信息。 .rsrc：包含程序使用的资源，包括图像、图标甚至嵌入的二进制文件。 .tls: ( T thread Local S torage )，为程序的每个执行线程提供存储。 PEview视图:
 1.DOS MZ Heade    DOS头结构
DOS_MZ_HEADER:
此结构中 重点参数为e_magic 和 e_lfanew, e_magic 占用两个字节 4D 5A ,转换成字符为MZ,位置在于文件的最开始,可执行文件中不可缺少的一部分."/>

    <meta property="og:title" content="PE文件初探_中" />
<meta property="og:description" content="稍微详细一点的PE结构    PE文件结构图:
1. DOS MZ Header————IMAGE_DOS_HEADER	DOS MZ 头 2. DOS stub———————MS-DOS Stub Program	DOS 根 3. PE Header——————IMAGE_NT_HEADERS	PE头(NT 头) 4. Section table—————MAGE_SECTION_HEADER 区段头 5.1 Section 1	(.text)	SECTION.text	区段 .text 5-2 Section 2	(.data)	SECTION.data	区段 .data .text：包含程序的可执行代码。 .data:包含初始化数据。 .bss：包含未初始化的数据。 .rdata:包含只读的初始化数据。 .edata：包含导出表。 .idata：包含导入表。 .reloc：包含图像重定位信息。 .rsrc：包含程序使用的资源，包括图像、图标甚至嵌入的二进制文件。 .tls: ( T thread Local S torage )，为程序的每个执行线程提供存储。 PEview视图:
 1.DOS MZ Heade    DOS头结构
DOS_MZ_HEADER:
此结构中 重点参数为e_magic 和 e_lfanew, e_magic 占用两个字节 4D 5A ,转换成字符为MZ,位置在于文件的最开始,可执行文件中不可缺少的一部分." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://justabandon.github.io/posts/pe%E6%96%87%E4%BB%B6%E5%88%9D%E6%8E%A2_%E4%B8%AD/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-25T18:12:03+08:00" />
<meta property="article:modified_time" content="2022-04-25T18:12:03+08:00" />



    <title>
  PE文件初探_中 · record and share
</title>

    
      <link rel="canonical" href="https://justabandon.github.io/posts/pe%E6%96%87%E4%BB%B6%E5%88%9D%E6%8E%A2_%E4%B8%AD/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.728f45c9eaff821acb9cccdb60c81cf16be81bd890ee22cc5b5f4dbf276a082f.css" integrity="sha256-co9Fyer/ghrLnMzbYMgc8WvoG9iQ7iLMW19NvydqCC8=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.aa883b9ce35a8ff4a2a5008619005175e842bb18a8a9f9cc2bbcf44dab2d91fa.css" integrity="sha256-qog7nONaj/SipQCGGQBRdehCuxioqfnMK7z0Tastkfo=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <meta name="generator" content="Hugo 0.92.1" />
  </head>

  
  
    
  
  <body class="preload-transitions colorscheme-auto">
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      record and share
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/chat/">Chat</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/images/">Images</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://justabandon.github.io/posts/pe%E6%96%87%E4%BB%B6%E5%88%9D%E6%8E%A2_%E4%B8%AD/">
              PE文件初探_中
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-04-25T18:12:03&#43;08:00">
                April 25, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              2-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div>
        
        <h1 id="稍微详细一点的pe结构">
  稍微详细一点的PE结构
  <a class="heading-link" href="#%e7%a8%8d%e5%be%ae%e8%af%a6%e7%bb%86%e4%b8%80%e7%82%b9%e7%9a%84pe%e7%bb%93%e6%9e%84">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>PE文件结构图:</p>
<p><img src="/images/pefile.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1. DOS MZ Header————IMAGE_DOS_HEADER		DOS MZ 头
2. DOS stub———————MS-DOS Stub Program		  DOS 根
3. PE Header——————IMAGE_NT_HEADERS			PE头(NT 头)
4. Section table—————MAGE_SECTION_HEADER   区段头
5.1 Section 1	(.text)		SECTION.text							  区段 .text
5-2 Section 2	(.data)		SECTION.data							区段 .data

.text：包含程序的可执行代码。
.data:包含初始化数据。
.bss：包含未初始化的数据。
.rdata:包含只读的初始化数据。
.edata：包含导出表。
.idata：包含导入表。
.reloc：包含图像重定位信息。
.rsrc：包含程序使用的资源，包括图像、图标甚至嵌入的二进制文件。
.tls: ( T thread Local S torage )，为程序的每个执行线程提供存储。
</code></pre></div><p>PEview视图:</p>
<p><img src="/images/peiew.png" alt="PEview视图"></p>
<hr>
<h2 id="1dos-mz-heade">
  1.DOS MZ Heade
  <a class="heading-link" href="#1dos-mz-heade">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>DOS头结构</p>
<p>DOS_MZ_HEADER:</p>
<p><img src="/images/dos_header.png" alt=""></p>
<p>此结构中 重点参数为e_magic  和 e_lfanew,  e_magic 占用两个字节 4D 5A ,转换成字符为MZ,位置在于文件的最开始,可执行文件中不可缺少的一部分. e_lfanew 代表指向PE Header的偏移量,占用4个字节.</p>
<p><img src="/images/dos_header2.png" alt="img"></p>
<blockquote>
<p>中间数据的改变并不会影响程序的执行  只要MZ头 和 PE头 指向正确。</p>
</blockquote>
<hr>
<h2 id="2dos-stub">
  2.DOS Stub
  <a class="heading-link" href="#2dos-stub">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>DOS stub的存在是为了在 DOS系统下运行PE文件考虑兼容性输出的一条语句 “This program cannot be run in DOS mode”.</p>
<p>如果你是用vs编译的文件  那么DOS Stub会多出一块区域 名为: Rich Header
Rich Header是由微软编译器创建  它包含链接库版本信息以及链接器版本。</p>
<p>含义不做深究</p>
<p><img src="/images/dos_stub.png" alt="DOS Stub"></p>
<p>DOS Header的结尾(e_lfanew)    PE头的开始 中间这部分就是 DOS stub, 可运行在DOS 系统中, 抹除此部分数据  只要 DOS header的 PE偏移指向正确并不会影响应用程序的执行</p>
<hr>
<h2 id="3pe-header">
  3.PE Header
  <a class="heading-link" href="#3pe-header">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>PE Header 也叫 NT Header,包含了 PE签名 Signature,文件头 IMAGE_FILE_HEADER,和 可选头 IMAGE_OPTIONAL_HEADER.</p>
<p><img src="/images/nt_header.png" alt="NT Header"></p>
<p>PE Header的位置从DOS Header 的 e_lfanew 指向而来</p>
<p><img src="/images/pe_header.png" alt="PE Header"></p>
<p><strong>Signature</strong>：50 45 00 00 代表PE字串标识(签名 ) 4字节</p>
<p><strong>IMAGE_FILE_HEADER</strong> 文件头:
<img src="/images/pe_file_header.png" alt="IMAGE_FILE_HEADER"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">IMAGE_FILE_HEADER : 64 86 06 00 62 32 61 62 00 00 00 00 00 00 00 00 F0 00 22 00	(映像文件头 COFF头  20字节  )
64 86 ==Machine amd64
06 00 == 节表数量
62 32 61 62 ==文件时间 转换成10进制后是 unix时间戳
00 00 00 00 == PointerToSymbolTable	 COFF指针偏移 	以停止使用
00 00 00 00 == NumberOfSymbols			以停止使用
F0 00 == 可选头大小
22 00 == 文件属性标记   目标的 32 位 RVA。  详见microsoft文档 https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#machine-types
</code></pre></div><p>**IMAGE_OPTIONAL_HEADER ** 可选头:</p>
<p>在几乎所有的参考书中都被称作“可选头”。虽然被称作可选头(因为某些文件类型（如目标文件）没有它，但是此标头对于图像文件是必不可少的。)，但是该头部不是一个可选的，而是一个必须存在的头，不可以没有。该头被称作“可选头”的原因是在该头的数据目录数组中，有的数据目录项是可有可无的，数据目录项部分是可选的，因此称为“可选头”。它定义了PE文件的很多关键信息。大小可从 文件头-IMAGE_FILE_HEADER 中得知。可选头紧挨着文件头，文件头的结束位置在 0x000000DF，那么可选头的起始位置为0x000000E0。结构本身的大小（或结构内定义的成员数）： IMAGE_OPTIONAL_HEADER32有 31 个成员，而IMAGE_OPTIONAL_HEADER64只有 30 个成员，32 位版本中的附加成员是一个名为 DWORD BaseOfData，它保存数据开头的 RVA部分。</p>
<p>from microsoft doc:</p>
<p>请注意，可选标头的大小不是固定的。COFF 标头中的SizeOfOptionalHeader字段必须用于验证对特定数据目录的文件的探测不会超出SizeOfOptionalHeader。有关详细信息，请参阅COFF 文件头（对象和图像）。
可选标头的NumberOfRvaAndSizes字段也应该用于确保对特定数据目录条目的探测不会超出可选标头。此外，验证可选的标头幻数以实现格式兼容性也很重要。</p>
<p><img src="/images/pe_optional_header.png" alt="IMAGE_OPTIONAL_HEADER"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">CTRL+C  CTRL+V   -.-

1.Magic，表明是ROM映像还是普通的可执行映像，普通的可执行文件的值为0x010B，PE32+可执行文件的值为0x020B（PE32+即64位的PE文件，这种文件只能运行在64位的Windows操作系统下）；
2.MajorLinkerVersion，链接器的主版本号；
3.MinorLinkerVersion，链接器的次版本号；
4.SizeOfCode，代码区块的大小，通常而言可执行文件仅有一个代码区块.text，所以通常就是.text区块的大小；
5.SizeOfInitializedData，已初始化数据块的大小，不作研究；
6.SizeOfUninitializedData，未初始化数据块的大小，不作研究；
7.AddressOfEntryPoint，重要字段，程序执行的入口点地址，是一个RVA值；
8.BaseOfCode，代码段的起始地址，是一个RVA值，通常而言就是.text区块的起始RVA；
9.BaseOfData，数据段的起始地址，是一个RVA值，通常而言就是.data区块的起始RVA；
10.ImageBase，重要字段，PE文件在内存中首选的装载基地址；
11.SectionAlignment，当PE文件装载到内存时区块的对齐大小，假设.text区块的大小为0x7748，而SectionAlignment的大小为0x1000，那么对齐后的大小为0x8000字节；
12.FileAlignment，磁盘上PE文件中区块的对齐大小，对齐方式类似SectionAlignment；
13.MajorOperatingSystemVersion，要求的操作系统最低的主版本号；
14.MinorOperatingSystemVersion，要求的操作系统最低的次版本号；
15.MajorImageVersion，PE文件本身的主版本号；
16.MinorImageVersion，PE文件本身的次版本号；
17.MajorSubsystemVersion，要求的子系统最低的主版本号；
18.MinorSubsystemVersion，要求的子系统最低的次版本号；
19.Win32VersionValue，保留字段，通常为0；
20.SizeOfImage，PE文件被装载到内存空间后总的大小，指从ImageBase到最后一个区块的大小；
21.SizeOfHeaders，Dos头、DosStub、PE头以及区块头的总大小，并进行FileAlignment对齐后的大小；
22.CheckSum，校验和，一般的EXE文件通常为0，对重要的系统驱动程序而言比较有意义；
23.Subsystem，子系统，EXE最常用的子系统类型有console以及windows，分别对应控制台应用程序以及GUI应用程序；
24.DllCharacteristics，包含有DEP以及ASLR相关的属性位；
25.SizeOfStackReserve，不作研究；
26.SizeOfStackCommit，不作研究；
27.SizeOfHeapReserve，不作研究；
28.SizeOfHeapCommit，不作研究；
29.LoaderFlags，与调试相关，不作研究；
30.NumberOfRvaAndSizes，数据目录项的个数，固定为16，即后面一个成员DataDirectory的数组元素个数；
31.DataDirectory，数据目录表，包含有输入表、输出表等表项的具体信息。
</code></pre></div><p><strong>个人认为比较重要的参数</strong>:
牵扯到几个概念</p>
<ul>
<li>
<p>每个进程都存在4g虚拟空间(2g用户空间  2g系统空间)</p>
</li>
<li>
<p>Relative Virtual Address(rva) 相对虚拟地址 它是相对内存中ImageBase的偏移地址 imagebase(指针)+rva(偏移量)= 内存中绝对地址</p>
</li>
<li>
<p>对齐粒度  通常,文件中的对齐粒度为0x200(hex 512)	内存中对齐粒度为0x1000(hex , 4096 一页 4k)   (已使用的不变 未使用的填0对齐)</p>
</li>
</ul>
<blockquote>
<p>Magic	—— 表明是ROM映像还是普通的可执行映像，普通的可执行文件的值为0x010B，PE32+可执行文件的值为0x020B（PE32+即64位的PE文件，这种文件只能运行在64位的Windows操作系统下</p>
</blockquote>
<blockquote>
<p>SizeOfCode	——	.text 代码段的大小(参考 对齐粒度的存在)</p>
</blockquote>
<blockquote>
<p>AddressOfEntryPoint	——	程序执行的入口点地址，是一个RVA值(RVA 相对地址, imagebase + EntryPoint 就是内存中的绝对地址)</p>
</blockquote>
<blockquote>
<p>BaseOfCode	——	代码段的起始地址，是一个RVA值，通常而言就是.text区块的起始RVA；</p>
</blockquote>
<blockquote>
<p>BaseOfData	——	数据段的起始地址，是一个RVA值，通常而言就是.data区块的起始RVA；</p>
</blockquote>
<blockquote>
<p>ImageBase	——	重要字段，PE文件在内存中首选的装载基地址(ImageBase + RVA = 内存绝对地址)</p>
</blockquote>
<blockquote>
<p>FileAlignment	——	磁盘上PE文件中区块的对齐大小，对齐方式类似SectionAlignment(对齐粒度)</p>
</blockquote>
<blockquote>
<p>SizeOfImage	——	PE文件被装载到内存空间后总的大小，指从ImageBase到最后一个区块的大小</p>
</blockquote>
<blockquote>
<p>SizeOfHeaders	——	Dos头、DosStub、PE头以及区块头的总大小，并进行FileAlignment对齐后的大小</p>
</blockquote>
<blockquote>
<p>DataDirectory	——	数据目录表，包含有输入表、输出表等表项的具体信息</p>
</blockquote>
<p><strong>以上相关参数 均可在可选头区域与位置相对应,具体就不贴出来了.</strong></p>
<p><strong>代码的编译,除了关于代码方面的 .text .data .edata 等等 其他的都是有规律的,此部分 我个人理解为PE Loader的必要参数. 到现在来看 将PE文件转换成shellcode变成了将PE loader转换成shellcode 并且加载相关代码段</strong></p>
<blockquote>
<p>PE loader里的参数 大部分均可根据寻址来定位位置</p>
</blockquote>
<blockquote>
<p>寻址:  PE标头 在 DOS HEADER的 3Ch处, 假设存放E0  那么 F0(50 45 00 00 , &ldquo;PE\0\0&quot;字串 占4字节)+4+14(IMAGE_FILE_HEADER 20字节)=IMAGE_OPTIONAL_HEADER的起始位置(0XF0+0X4+0X14)终点位置: 可选头的大小在 IMAGE_NT_HEADERS 中的 FILE_HEADER_FileHeader 中的 SizeOfOptionHeader决定   查看 IMAGE_FILE_HEADER 倒数第4个字节-倒数第3个字节处加上起始位置就是 终点位置</p>
</blockquote>
<blockquote>
<p>比如	0XF0+0X04+0X14(十进制的20) = 108       IMAGE_NT_HEADERS 中的 FILE_HEADER_FileHeader 中的 SizeOfOptionHeader 为 00F0,  0XF0+0X04+0X14+0XF0=1F8  就是终点位置</p>
</blockquote>
<hr>
<p>from PE Bear:</p>
<p><img src="/images/pe_bear.png" alt=""></p>
<p><strong>可选头的大小在 IMAGE_NT_HEADERS 中的 FILE_HEADER_FileHeader 中的 SizeOfOptionHeader决定</strong></p>
<p><img src="/images/kxtdx.png" alt=""></p>
<hr>
<p><strong>说的有点乱了,总结一下</strong>:</p>
<ul>
<li>
<p>DOS Header: e_magic的参数定义了MZ头,e_lfanew定义了PE Header的相对位置,MZ头和PE Header的相对位置是PE文件不可缺少的一部分,影响着PE文件的运行.</p>
</li>
<li>
<p>DOS Stub:	用处不大,但这份空间可以对其加以利用,可以识别VS编译程序.</p>
</li>
<li>
<p>PE Header(NT Header): 包含3个参数,Signature、IMAGE_FILE_HEADER、IMAGE_OPTIONAL_HEADER,PE loader文件结构中的重要一部分,定义了PE字串标示、文件创建时间、ImageBase、.text代码段的大小、代码断起始地址、文件对齐粒度分配、导入导出表等等多个重要参数.</p>
</li>
<li>
<p>每个进程都存在4g虚拟空间,就算PC端只有2G物理内存,但每个进程始终会有4g虚拟空间. 4g虚拟空间的划分为2g用户空间与2g系统空间,由于windows api的机制和dll概念的存在,调用某些系统dll函数的时候只会在系统空间进行,每个进程调用同样的系统dll函数 并不会引起冲突.用户空间大部分处理文件的正常运行与代码编译时候的变量常量的存放和其他功能.</p>
</li>
<li>
<p>PE文件使用十六进制编辑器的地址在内存中运行的时候会发生改变,RVA和ImageBase的存在(类似于指针+偏移)可定位内存中的绝对地址.</p>
</li>
<li>
<p>对齐粒度将PE文件结构的各个区域进行了整片划分,文件中和内存中的对齐粒度不一样,已占用的字节不变剩下的按照对齐粒度进行填充.</p>
</li>
</ul>
<hr>
<p>更加好的文章:</p>
<p><a href="https://blog.csdn.net/u013761036/article/details/52751623">TK13</a>
<a href="https://0xrick.github.io/tags/#pe">0Xrick</a></p>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    ©
    
    2022
     Just Abandon 
    ·
    
    
  </section>
</footer>

    </main>

    
      
      <script src="/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js" integrity="sha256-A7F3afT5GuNWZ&#43;HyocqMFvUFYlds&#43;Q/zKzF5kmkU2qU="></script>
    

    

    

    

    

    

    

    

    
  </body>

</html>
