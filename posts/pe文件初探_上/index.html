<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="Just Abandon">
    <meta name="description" content="#PE文件初探
 前言: 最近在研究免杀方面的知识和碰到一个有趣的工具 PE文件转shellcode 并对此进行探索而记录此文章
 1.什么是PE文件    PE文件是Windows操作系统下使用的一种可执行文件，由COFF（UNIX平台下的通用对象文件格式）格式文件发展而来。32位称为PE32，64位称为PE&#43;或PE32&#43;。
可移植可执行文件( PE ) 格式是用于32 位和 64 位版本的Windows操作系统的可执行文件、目标代码、DLL和其他文件格式。PE 格式是一种数据结构，它封装了 Windows 操作系统加载程序管理打包的可执行代码所需的信息。这包括链接、API导出和导入表、资源管理数据和线程本地存储(TLS) 数据的动态库引用。在NT操作系统上，PE 格式用于EXE 、DLL、SYS（设备驱动程序）、MUI等文件类型。统一可扩展固件接口 (UEFI)规范指出 PE 是 EFI 环境中的标准可执行格式
PE是一种数据格式,拥有这种数据格式的文件称作PE文件
2.PE文件格式    常见PE文件后缀:
 可执行文件 EXE,SCR
  库系列 DLL, OCX, CPL, DRV
  驱动程序系列 SYS, VXD
  对象文件系列 OBJ
  基本结构分为头与体,以下为PE文件基本结构简单描述,详细信息有机会再加
头:
 DOS Header （DOS头)
  DOS stub (DOS根)
  NT Header (NT 头)">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PE文件初探_上"/>
<meta name="twitter:description" content="#PE文件初探
 前言: 最近在研究免杀方面的知识和碰到一个有趣的工具 PE文件转shellcode 并对此进行探索而记录此文章
 1.什么是PE文件    PE文件是Windows操作系统下使用的一种可执行文件，由COFF（UNIX平台下的通用对象文件格式）格式文件发展而来。32位称为PE32，64位称为PE&#43;或PE32&#43;。
可移植可执行文件( PE ) 格式是用于32 位和 64 位版本的Windows操作系统的可执行文件、目标代码、DLL和其他文件格式。PE 格式是一种数据结构，它封装了 Windows 操作系统加载程序管理打包的可执行代码所需的信息。这包括链接、API导出和导入表、资源管理数据和线程本地存储(TLS) 数据的动态库引用。在NT操作系统上，PE 格式用于EXE 、DLL、SYS（设备驱动程序）、MUI等文件类型。统一可扩展固件接口 (UEFI)规范指出 PE 是 EFI 环境中的标准可执行格式
PE是一种数据格式,拥有这种数据格式的文件称作PE文件
2.PE文件格式    常见PE文件后缀:
 可执行文件 EXE,SCR
  库系列 DLL, OCX, CPL, DRV
  驱动程序系列 SYS, VXD
  对象文件系列 OBJ
  基本结构分为头与体,以下为PE文件基本结构简单描述,详细信息有机会再加
头:
 DOS Header （DOS头)
  DOS stub (DOS根)
  NT Header (NT 头)"/>

    <meta property="og:title" content="PE文件初探_上" />
<meta property="og:description" content="#PE文件初探
 前言: 最近在研究免杀方面的知识和碰到一个有趣的工具 PE文件转shellcode 并对此进行探索而记录此文章
 1.什么是PE文件    PE文件是Windows操作系统下使用的一种可执行文件，由COFF（UNIX平台下的通用对象文件格式）格式文件发展而来。32位称为PE32，64位称为PE&#43;或PE32&#43;。
可移植可执行文件( PE ) 格式是用于32 位和 64 位版本的Windows操作系统的可执行文件、目标代码、DLL和其他文件格式。PE 格式是一种数据结构，它封装了 Windows 操作系统加载程序管理打包的可执行代码所需的信息。这包括链接、API导出和导入表、资源管理数据和线程本地存储(TLS) 数据的动态库引用。在NT操作系统上，PE 格式用于EXE 、DLL、SYS（设备驱动程序）、MUI等文件类型。统一可扩展固件接口 (UEFI)规范指出 PE 是 EFI 环境中的标准可执行格式
PE是一种数据格式,拥有这种数据格式的文件称作PE文件
2.PE文件格式    常见PE文件后缀:
 可执行文件 EXE,SCR
  库系列 DLL, OCX, CPL, DRV
  驱动程序系列 SYS, VXD
  对象文件系列 OBJ
  基本结构分为头与体,以下为PE文件基本结构简单描述,详细信息有机会再加
头:
 DOS Header （DOS头)
  DOS stub (DOS根)
  NT Header (NT 头)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://justabandon.github.io/posts/pe%E6%96%87%E4%BB%B6%E5%88%9D%E6%8E%A2_%E4%B8%8A/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-20T18:50:34+08:00" />
<meta property="article:modified_time" content="2022-04-20T18:50:34+08:00" />



    <title>
  PE文件初探_上 · record and share
</title>

    
      <link rel="canonical" href="https://justabandon.github.io/posts/pe%E6%96%87%E4%BB%B6%E5%88%9D%E6%8E%A2_%E4%B8%8A/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.728f45c9eaff821acb9cccdb60c81cf16be81bd890ee22cc5b5f4dbf276a082f.css" integrity="sha256-co9Fyer/ghrLnMzbYMgc8WvoG9iQ7iLMW19NvydqCC8=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.aa883b9ce35a8ff4a2a5008619005175e842bb18a8a9f9cc2bbcf44dab2d91fa.css" integrity="sha256-qog7nONaj/SipQCGGQBRdehCuxioqfnMK7z0Tastkfo=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <meta name="generator" content="Hugo 0.92.1" />
  </head>

  
  
    
  
  <body class="preload-transitions colorscheme-auto">
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      record and share
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/chat/">Chat</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/images/">Images</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://justabandon.github.io/posts/pe%E6%96%87%E4%BB%B6%E5%88%9D%E6%8E%A2_%E4%B8%8A/">
              PE文件初探_上
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-04-20T18:50:34&#43;08:00">
                April 20, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              One-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div>
        
        <p>#PE文件初探</p>
<blockquote>
<p>前言:
最近在研究免杀方面的知识和碰到一个有趣的工具 <a href="https://github.com/hasherezade/pe_to_shellcode">PE文件转shellcode</a> 并对此进行探索而记录此文章</p>
</blockquote>
<h2 id="1什么是pe文件">
  1.什么是PE文件
  <a class="heading-link" href="#1%e4%bb%80%e4%b9%88%e6%98%afpe%e6%96%87%e4%bb%b6">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>PE文件是Windows操作系统下使用的一种可执行文件，由COFF（UNIX平台下的通用对象文件格式）格式文件发展而来。32位称为PE32，64位称为PE+或PE32+。</p>
<p>可移植可执行文件( PE ) 格式是用于32 位和 64 位版本的Windows操作系统的可执行文件、目标代码、DLL和其他文件格式。PE 格式是一种数据结构，它封装了 Windows 操作系统加载程序管理打包的可执行代码所需的信息。这包括链接、API导出和导入表、资源管理数据和线程本地存储(TLS) 数据的动态库引用。在NT操作系统上，PE 格式用于EXE 、DLL、SYS（设备驱动程序）、MUI等文件类型。统一可扩展固件接口 (UEFI)规范指出 PE 是 EFI 环境中的标准可执行格式</p>
<p>PE是一种数据格式,拥有这种数据格式的文件称作PE文件</p>
<h2 id="2pe文件格式">
  2.PE文件格式
  <a class="heading-link" href="#2pe%e6%96%87%e4%bb%b6%e6%a0%bc%e5%bc%8f">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>常见PE文件后缀:</p>
<blockquote>
<p>可执行文件  EXE,SCR</p>
</blockquote>
<blockquote>
<p>库系列   DLL, OCX, CPL, DRV</p>
</blockquote>
<blockquote>
<p>驱动程序系列  SYS, VXD</p>
</blockquote>
<blockquote>
<p>对象文件系列  OBJ</p>
</blockquote>
<hr>
<p>基本结构分为头与体,以下为PE文件基本结构简单描述,详细信息有机会再加</p>
<p>头:</p>
<blockquote>
<p>DOS Header  （DOS头)</p>
</blockquote>
<blockquote>
<p>DOS stub  (DOS根)</p>
</blockquote>
<blockquote>
<p>NT Header    (NT 头)</p>
</blockquote>
<blockquote>
<blockquote>
<p>Signature	(签名)</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>File Header	(文件头)</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>Optional Header	(可选头)</p>
</blockquote>
</blockquote>
<blockquote>
<p>Section Headers	(区段头)</p>
</blockquote>
<hr>
<p>体:</p>
<blockquote>
<p>section	(区段)</p>
</blockquote>
<blockquote>
<blockquote>
<p>.text	(可执行代码段)</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>.rdata	(只读以初始化的数据段)</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>.data	(以初始化的数据段)</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>.rsrc	(资源段)</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>.reloc	(重定位表)</p>
</blockquote>
</blockquote>
<hr>
<h2 id="3pe文件是怎么运行的">
  3.PE文件是怎么运行的
  <a class="heading-link" href="#3pe%e6%96%87%e4%bb%b6%e6%98%af%e6%80%8e%e4%b9%88%e8%bf%90%e8%a1%8c%e7%9a%84">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>目前想法:代码的运行存入.text段,其他段作为可执行的辅助, 代码的编译也是将高级语言转换为低级语言并按照分类进行存放.至此,我认为可执行文件的加载过程为: 代码的编译器处理好相关导入导出函数地址的索引以及常量变量以及其他信息的存放并编译成可执行文件,程序的加载按照PE文件格式的顺序逻辑执行,其中编译器可能将一些无关的代码进行了跳转,到了.text 段 代码的逻辑以及常量变量的索引 函数的调用向其他区段 内存空间 索引调用 向下运行 直到退出。</p>
<p>那么 该如何将PE文件转换为可直接加载的shell code？
根具上面的理解此时有两个想法:</p>
<ol>
<li>
<p>如果说 PE文件的结构 更多的是进行预加载过程 .text是程序执行代码段, 将该文件的预加载过程提前初始化后在去将 section 里的 hex 字节作为shellcode 的加载,这样就不会因为寻址或引用出现问题而导致错误。</p>
</li>
<li>
<p>重构PE文件的预加载过程,将整个PE文件的hex 字节 作为shellcode的加载, 预处理过程 在PE文件重构时已经规划好 直接进行内存的加载执行。</p>
</li>
</ol>
<blockquote>
<p>如何做到？ 由于缺少相关方面的知识准备先去看看相关资料 其中涉及的应该有: windows PE文件加载过程和结构、汇编、C\C++。</p>
</blockquote>
<blockquote>
<p>以上内容只是个人猜想 并非借鉴相关资料的实证,看看就好 不必当真。 待续&hellip;&hellip;.</p>
</blockquote>
<hr>
<p><strong>以下链接给了我很大帮助</strong></p>
<p><a href="https://cloud.tencent.com/developer/article/1597699">无文件执行:一切皆是shellcode (对pe_to_shellcode 分析)</a></p>
<p><a href="https://www.cnblogs.com/hanfenglun/archive/2009/03/20/1417487.html">PE结构  https://www.cnblogs.com/hanfenglun/archive/2009/03/20/1417487.htm</a></p>
<p><a href="https://fightingtree.github.io/2020/03/23/reverse2/">PE文件分析 https://fightingtree.github.io/2020/03/23/reverse2/</a></p>
<p>慕课网的软件安全之恶意代码机理与防护</p>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    ©
    
    2022
     Just Abandon 
    ·
    
    
  </section>
</footer>

    </main>

    
      
      <script src="/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js" integrity="sha256-A7F3afT5GuNWZ&#43;HyocqMFvUFYlds&#43;Q/zKzF5kmkU2qU="></script>
    

    

    

    

    

    

    

    

    
  </body>

</html>
